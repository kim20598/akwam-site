{% extends "base.html" %}

{% block title %}مشاهدة {{ content.title }} - أكوام{% endblock %}
{% block description %}مشاهدة {{ content.title }} على أكوام{% endblock %}
{% block og_title %}مشاهدة {{ content.title }}{% endblock %}
{% block og_description %}مشاهدة {{ content.title }} على أكوام{% endblock %}
{% block og_image %}{{ content.thumbnail_url }}{% endblock %}
{% block canonical_url %}https://akwam.com/watch/{{ content.id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/css/player.css">
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<style>
    .watch-container {
        padding-top: 80px;
        background: #000;
        min-height: 100vh;
    }
    
    .player-section {
        position: relative;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .video-wrapper {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        background: #000;
    }
    
    #player {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    .content-info {
        padding: 20px;
        background: var(--bg-light);
        margin-top: 20px;
        border-radius: 10px;
    }
    
    .content-title {
        font-size: 24px;
        margin-bottom: 10px;
        color: var(--text-color);
    }
    
    .content-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        color: var(--text-secondary);
        font-size: 14px;
    }
    
    .content-description {
        line-height: 1.6;
        color: var(--text-secondary);
        margin-bottom: 20px;
    }
    
    .episode-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding: 15px;
        background: var(--bg-dark);
        border-radius: 5px;
    }
    
    .nav-btn {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: var(--bg-light);
        border: none;
        color: var(--text-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .nav-btn:hover {
        background: var(--primary-color);
        color: white;
    }
    
    .nav-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .quality-selector {
        margin-top: 20px;
    }
    
    .quality-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }
    
    .quality-option {
        padding: 8px 15px;
        background: var(--bg-dark);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .quality-option:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .quality-option.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--border-color);
        border-top: 5px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="watch-container">
    <div class="container">
        <div class="player-section">
            <div class="video-wrapper">
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="loading-spinner"></div>
                </div>
                
                <!-- Video Player -->
                <video id="player" playsinline controls>
                    <!-- Sources will be added by JavaScript -->
                </video>
            </div>
            
            <!-- Content Info -->
            <div class="content-info">
                <h1 class="content-title" id="contentTitle">{{ content.title }}</h1>
                
                <div class="content-meta">
                    {% if content.year %}
                    <span><i class="fas fa-calendar"></i> {{ content.year }}</span>
                    {% endif %}
                    
                    {% if content.type %}
                    <span><i class="fas fa-{{ content.type == 'movie' ? 'film' : 'tv' }}"></i> 
                        {{ content.type == 'movie' ? 'فيلم' : 'مسلسل' }}
                    </span>
                    {% endif %}
                    
                    {% if content.duration %}
                    <span><i class="fas fa-clock"></i> {{ content.duration }} دقيقة</span>
                    {% endif %}
                </div>
                
                {% if content.description %}
                <p class="content-description">{{ content.description }}</p>
                {% endif %}
                
                <!-- Quality Selector -->
                <div class="quality-selector">
                    <h3><i class="fas fa-hd"></i> جودة الفيديو</h3>
                    <div class="quality-options" id="qualityOptions">
                        <!-- Quality options will be loaded by JavaScript -->
                    </div>
                </div>
                
                <!-- Episode Navigation (for series) -->
                {% if episodes and episodes|length > 1 %}
                <div class="episode-navigation">
                    <button class="nav-btn" id="prevEpisode" onclick="playPreviousEpisode()" disabled>
                        <i class="fas fa-arrow-right"></i> الحلقة السابقة
                    </button>
                    
                    <div class="current-episode">
                        الحلقة {{ current_episode_number }} من {{ episodes|length }}
                    </div>
                    
                    <button class="nav-btn" id="nextEpisode" onclick="playNextEpisode()" disabled>
                        الحلقة التالية <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Related Content -->
        {% if related_content %}
        <div class="related-content">
            <div class="section-header">
                <h2><i class="fas fa-fire"></i> قد يعجبك أيضًا</h2>
            </div>
            <div class="movies-grid">
                {% for related in related_content %}
                <div class="movie-card">
                    <a href="/{{ related.type }}/{{ related.id }}">
                        <img src="{{ related.poster_url }}" 
                             alt="{{ related.title }}"
                             class="movie-poster"
                             onerror="this.src='/assets/images/poster-placeholder.jpg'">
                        <div class="movie-info">
                            <h3 class="movie-title">{{ related.title }}</h3>
                            <div class="movie-meta">
                                <span class="movie-type">
                                    {{ related.type == 'movie' ? 'فيلم' : 'مسلسل' }}
                                </span>
                                {% if related.year %}
                                <span>{{ related.year }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
<script>
    // Player configuration
    const playerConfig = {
        controls: [
            'play', 
            'progress', 
            'current-time', 
            'duration', 
            'mute', 
            'volume',
            'settings',
            'pip',
            'fullscreen'
        ],
        settings: ['quality', 'speed'],
        speed: {
            selected: 1,
            options: [0.5, 0.75, 1, 1.25, 1.5, 2]
        },
        keyboard: {
            focused: true,
            global: true
        },
        storage: {
            enabled: true,
            key: 'akwam-player'
        },
        iconUrl: 'https://cdn.plyr.io/3.7.8/plyr.svg'
    };
    
    // Initialize player
    const player = new Plyr('#player', playerConfig);
    
    // State variables
    let currentQuality = 'auto';
    let videoSources = [];
    let episodes = {{ episodes|tojson|safe }};
    let currentEpisodeIndex = {{ current_episode_index|default(0) }};
    
    // Load video on page load
    document.addEventListener('DOMContentLoaded', async function() {
        const contentId = '{{ content.id }}';
        const contentType = '{{ content.type }}';
        
        // Load video sources
        await loadVideoSources(contentId);
        
        // Update episode navigation
        updateEpisodeNavigation();
        
        // Setup player events
        setupPlayerEvents();
        
        // Hide loading overlay
        document.getElementById('loadingOverlay').style.display = 'none';
    });
    
    async function loadVideoSources(contentId) {
        try {
            const response = await fetch(`/api/watch/${contentId}`);
            const data = await response.json();
            
            if (data.success && data.sources) {
                videoSources = data.sources;
                setupQualitySelector();
                playVideo();
            } else {
                showError('فشل تحميل مصادر الفيديو');
            }
        } catch (error) {
            console.error('Error loading video sources:', error);
            showError('فشل تحميل مصادر الفيديو');
        }
    }
    
    function setupQualitySelector() {
        const qualityOptions = document.getElementById('qualityOptions');
        const qualities = [...new Set(videoSources.map(source => source.quality))];
        
        qualities.forEach(quality => {
            const button = document.createElement('button');
            button.className = 'quality-option';
            button.textContent = quality;
            button.dataset.quality = quality;
            
            if (quality === currentQuality) {
                button.classList.add('active');
            }
            
            button.addEventListener('click', function() {
                changeQuality(quality);
            });
            
            qualityOptions.appendChild(button);
        });
    }
    
    function changeQuality(quality) {
        currentQuality = quality;
        
        // Update active button
        document.querySelectorAll('.quality-option').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.quality === quality) {
                btn.classList.add('active');
            }
        });
        
        // Change video source
        playVideo();
    }
    
    function playVideo() {
        const source = videoSources.find(s => s.quality === currentQuality) || videoSources[0];
        
        if (!source) {
            showError('لا توجد مصادر فيديو متاحة');
            return;
        }
        
        player.source = {
            type: 'video',
            sources: [{
                src: source.url,
                type: 'video/mp4',
                size: source.quality
            }]
        };
        
        // Store progress
        const progressKey = `progress_${source.url}`;
        const savedProgress = localStorage.getItem(progressKey);
        
        if (savedProgress) {
            const progress = JSON.parse(savedProgress);
            if (Date.now() - progress.timestamp < 7 * 24 * 60 * 60 * 1000) {
                player.on('loadedmetadata', () => {
                    player.currentTime = progress.time;
                });
            }
        }
    }
    
    function updateEpisodeNavigation() {
        if (episodes.length <= 1) {
            document.querySelector('.episode-navigation')?.style.display = 'none';
            return;
        }
        
        const prevBtn = document.getElementById('prevEpisode');
        const nextBtn = document.getElementById('nextEpisode');
        
        prevBtn.disabled = currentEpisodeIndex === 0;
        nextBtn.disabled = currentEpisodeIndex === episodes.length - 1;
        
        // Update episode counter
        document.querySelector('.current-episode').textContent = 
            `الحلقة ${currentEpisodeIndex + 1} من ${episodes.length}`;
    }
    
    function playPreviousEpisode() {
        if (currentEpisodeIndex > 0) {
            currentEpisodeIndex--;
            loadEpisode(episodes[currentEpisodeIndex].id);
        }
    }
    
    function playNextEpisode() {
        if (currentEpisodeIndex < episodes.length - 1) {
            currentEpisodeIndex++;
            loadEpisode(episodes[currentEpisodeIndex].id);
        }
    }
    
    async function loadEpisode(episodeId) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        try {
            // Update URL without reloading page
            history.pushState({}, '', `/watch.html?id=${episodeId}&type=series`);
            
            // Load new episode data
            await loadVideoSources(episodeId);
            
            // Update episode info
            const episode = episodes[currentEpisodeIndex];
            document.getElementById('contentTitle').textContent = episode.title;
            
            // Update navigation
            updateEpisodeNavigation();
            
            // Mark as watched
            markAsWatched(episodeId);
            
        } catch (error) {
            console.error('Error loading episode:', error);
            showError('فشل تحميل الحلقة');
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }
    
    function setupPlayerEvents() {
        // Track progress
        player.on('timeupdate', function() {
            if (player.currentTime > 0) {
                saveProgress();
            }
        });
        
        // Auto-play next episode
        player.on('ended', function() {
            if (episodes.length > 0 && currentEpisodeIndex < episodes.length - 1) {
                setTimeout(() => {
                    playNextEpisode();
                }, 3000);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (document.activeElement.tagName === 'INPUT') return;
            
            switch(e.key.toLowerCase()) {
                case 'arrowright':
                    e.preventDefault();
                    player.forward(10);
                    break;
                case 'arrowleft':
                    e.preventDefault();
                    player.rewind(10);
                    break;
                case 'n':
                    e.preventDefault();
                    playNextEpisode();
                    break;
                case 'p':
                    e.preventDefault();
                    playPreviousEpisode();
                    break;
            }
        });
    }
    
    function saveProgress() {
        const currentSource = videoSources.find(s => s.quality === currentQuality);
        if (!currentSource) return;
        
        const progress = {
            url: currentSource.url,
            time: player.currentTime,
            timestamp: Date.now()
        };
        
        localStorage.setItem(`progress_${currentSource.url}`, JSON.stringify(progress));
    }
    
    function markAsWatched(episodeId) {
        const watched = JSON.parse(localStorage.getItem('watched') || '{}');
        watched[episodeId] = true;
        localStorage.setItem('watched', JSON.stringify(watched));
    }
    
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle"></i>
            <p>${message}</p>
            <button onclick="location.reload()" class="btn btn-primary">
                إعادة المحاولة
            </button>
        `;
        
        document.querySelector('.player-section').appendChild(errorDiv);
    }
</script>
{% endblock %}
